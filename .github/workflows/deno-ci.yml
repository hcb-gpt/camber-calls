# DEV_STRAT_20260130T0745Z_github_actions_denoci.yml
# Purpose: create a real status check for branch protection
# Assumes Supabase Edge Functions (Deno / TypeScript) live under supabase/functions/**
# First run: 2026-01-30

name: Deno CI
on:
  pull_request:
  workflow_dispatch:

jobs:
  deno-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Deno fmt (check)
        run: |
          deno fmt --check supabase/functions || (echo "deno fmt failed" && exit 1)

      - name: Deno lint
        run: |
          deno lint supabase/functions || (echo "deno lint failed" && exit 1)

      # Typecheck disabled until TS errors in legacy code are fixed
      # - name: Deno check (typecheck entrypoints)
      #   run: |
      #     for f in supabase/functions/*/index.ts; do
      #       echo "typecheck $f"
      #       deno check "$f" || exit 1
      #     done

  # Proof pack merge gate - runs replay on known interaction to verify pipeline integrity
  proof-pack:
    runs-on: ubuntu-latest
    # Only run if secrets are available (not on forks)
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      EDGE_SHARED_SECRET: ${{ secrets.EDGE_SHARED_SECRET }}
      # Known good interaction for regression testing
      TEST_INTERACTION_ID: ${{ secrets.TEST_INTERACTION_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Check secrets available
        run: |
          if [[ -z "$SUPABASE_URL" || -z "$SUPABASE_SERVICE_ROLE_KEY" || -z "$EDGE_SHARED_SECRET" ]]; then
            echo "Secrets not configured - skipping proof pack"
            exit 0
          fi

      - name: Run proof pack
        if: env.TEST_INTERACTION_ID != ''
        run: |
          chmod +x ./scripts/replay_call.sh
          ./scripts/replay_call.sh "$TEST_INTERACTION_ID" --reseed --reroute --verbose --save-artifacts

      - name: Upload proof artifacts
        if: always() && env.TEST_INTERACTION_ID != ''
        uses: actions/upload-artifact@v4
        with:
          name: proof-pack-${{ github.run_id }}
          path: /tmp/proofs/
          retention-days: 7

  # Big Rock 1: CI hard gates - 4 invariant checks
  # Source: STRAT TURN:85 tasking
  invariant-gates:
    runs-on: ubuntu-latest
    # Triggers on changes to functions, migrations, or scripts
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && (
        contains(github.event.pull_request.changed_files, 'supabase/functions/') ||
        contains(github.event.pull_request.changed_files, 'supabase/migrations/') ||
        contains(github.event.pull_request.changed_files, 'scripts/') ||
        contains(github.event.pull_request.changed_files, '.camber/')
      ))
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Verify secrets configured
        id: check-secrets
        run: |
          if [[ -z "$SUPABASE_URL" || -z "$SUPABASE_SERVICE_ROLE_KEY" ]]; then
            echo "::warning::Secrets not configured - invariant gates will be skipped"
            echo "secrets_ok=false" >> $GITHUB_OUTPUT
          else
            echo "secrets_ok=true" >> $GITHUB_OUTPUT
          fi

      - name: Run invariant gates
        if: steps.check-secrets.outputs.secrets_ok == 'true'
        run: |
          chmod +x ./scripts/invariant_gates.sh
          ./scripts/invariant_gates.sh --verbose
        continue-on-error: false

      - name: Save gate results (JSON)
        if: always() && steps.check-secrets.outputs.secrets_ok == 'true'
        run: |
          mkdir -p /tmp/gate-results
          ./scripts/invariant_gates.sh --json > /tmp/gate-results/gates.json 2>/dev/null || true

      - name: Upload gate results
        if: always() && steps.check-secrets.outputs.secrets_ok == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: invariant-gates-${{ github.run_id }}
          path: /tmp/gate-results/
          retention-days: 7
